{% extends 'core/base.html' %}
{% load templateTags %}
{% load static %}
{% block content %}

    <div id='div-id-user-shelf-container'></div>

    {% paginationComponent request records %}

    <script type='text/babel'>

        class Tabs {
            constructor(name, description, url, columns, component) {
                this.name = name;
                this.description = description;
                this.url = url;
                this.columns = columns;
                this.component = component;
            }

            isActive() {
                const params = new URLSearchParams(window.location.search);
                const tab = params.get('tab');
                return tab === this.url;
            }
        }

        class BaseTableComponent extends React.Component {
            constructor(props) {
                super(props);

                this.state = {
                    style: {whiteSpaceNoWrap: {whiteSpace: 'nowrap'}}
                }
            }

            getTableHeader = () => {
                return this.props.tab.columns;
            }

            truncate = (str, n) => {
                return (str.length > n) ? str.slice(0, n - 1) + '...' : str;
            }

            renderAverageRatingStar = (rating) => {
                const roundedRating = Math.round(rating);
                let stars = [];
                for (let i = 1; i <= 5; i++) {
                    stars.push(<i key={i} className={i <= roundedRating ? 'fas fa-star' : 'far fa-star'}></i>);
                }
                return (
                    <span>
                        {stars.map((i) => i)}
                    </span>
                );
            }

            removeBookFromShelf = (isbn13, shelfKey) => {
                fetch('/api/v1/userReadingInfoApiVersion1/' + isbn13 + '/', {
                    method: 'PUT',
                    headers: {
                        'Content-Encoding': 'gzip',
                        'Content-type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    dataType: 'json',
                    body: JSON.stringify({'field': shelfKey, 'action': 'remove'})
                }).then((response) => response.json())
                    .then((response) => {
                        if (response.success) {
                            window.location.reload();
                        }
                    })
            }

            render = () => {
                return (
                    <table className='table'>
                        <thead className='thead-dark'>
                        <tr>
                            {this.getTableHeader().map((header, i) => <th scope='col' key={i}>{header}</th>)}
                        </tr>
                        </thead>
                        <tbody>
                        {this.getTableRows()}
                        </tbody>
                    </table>
                );
            }
        }

        class RatedAndReviewedBooksTable extends BaseTableComponent {
            constructor(props) {
                super(props);
            }

            getTableRows() {
                let rows = [];
                {% for record in records %}
                    rows.push({
                        title: '{{ record.book.title }}',
                        isbn13: '{{ record.book.isbn13 }}',
                        categories: JSON.parse('{{ record.book.categories|escapejs }}'.replace(/'/g, '"')),
                        rating: '{{ record.rating }}',
                        comment: '{{ record.comment }}',
                    });
                {% endfor %}

                return rows.map((row, i) => (
                    <tr key={i}>
                        <td data-toggle='tooltip' data-placement='top' title={row.title}>
                            <a href={`/book/${row.isbn13}`}> {this.truncate(row.title, 40)} </a>
                        </td>
                        <td data-toggle='tooltip' data-placement='top' title={row.categories.join(', ')}>
                            {this.truncate(row.categories.join(', '), 25)}
                        </td>
                        <td style={this.state.style.whiteSpaceNoWrap}>
                            {this.renderAverageRatingStar(parseFloat(row.rating))}
                        </td>
                        <td data-toggle='tooltip' data-placement='top' title={row.comment}>
                            {this.truncate(row.comment, 50)}
                        </td>
                    </tr>
                ));
            }

            render() {
                return super.render();
            }
        }

        class RecentlyViewedBooksTable extends BaseTableComponent {
            constructor(props) {
                super(props);
            }

            getTableRows() {
                let rows = [];
                {% for record in records %}
                    rows.push({
                        title: '{{ record.title }}',
                        isbn13: '{{ record.isbn13 }}',
                        categories: JSON.parse('{{ record.categories|escapejs }}'.replace(/'/g, '"')),
                        rating: '{{ record.averageRating }}'
                    });
                {% endfor %}

                return rows.map((row, i) => (
                    <tr key={i}>
                        <td data-toggle='tooltip' data-placement='top' title={row.title}>
                            <a href={`/book/${row.isbn13}`}> {this.truncate(row.title, 40)} </a>
                        </td>
                        <td data-toggle='tooltip' data-placement='top' title={row.categories.join(', ')}>
                            {this.truncate(row.categories.join(', '), 25)}
                        </td>
                        <td style={this.state.style.whiteSpaceNoWrap}>
                            {this.renderAverageRatingStar(parseFloat(row.rating))}
                        </td>
                    </tr>
                ));
            }
        }

        class FavouriteReadBooksTable extends BaseTableComponent {
            constructor(props) {
                super(props);
            }

            getTableRows() {
                let rows = [];
                {% for record in records %}
                    rows.push({
                        title: '{{ record.title }}',
                        isbn13: '{{ record.isbn13 }}',
                        categories: JSON.parse('{{ record.categories|escapejs }}'.replace(/'/g, '"')),
                        rating: '{{ record.averageRating }}'
                    });
                {% endfor %}

                return rows.map((row, i) => (
                    <tr key={i}>
                        <td data-toggle='tooltip' data-placement='top' title={row.title}>
                            <a href={`/book/${row.isbn13}`}> {this.truncate(row.title, 40)} </a>
                        </td>
                        <td data-toggle='tooltip' data-placement='top' title={row.categories.join(', ')}>
                            {this.truncate(row.categories.join(', '), 25)}
                        </td>
                        <td style={this.state.style.whiteSpaceNoWrap}>
                            {this.renderAverageRatingStar(parseFloat(row.rating))}
                        </td>
                        <td>
                            <button type="button" className="btn btn-danger btn-sm" onClick={() => this.removeBookFromShelf(row.isbn13, 'favouriteRead')}>
                                Remove
                            </button>
                        </td>
                    </tr>
                ));
            }
        }

        class ReadingNowBooksTable extends BaseTableComponent {
            constructor(props) {
                super(props);
            }

            getTableRows() {
                let rows = [];
                {% for record in records %}
                    rows.push({
                        title: '{{ record.title }}',
                        isbn13: '{{ record.isbn13 }}',
                        categories: JSON.parse('{{ record.categories|escapejs }}'.replace(/'/g, '"')),
                        rating: '{{ record.averageRating }}'
                    });
                {% endfor %}

                return rows.map((row, i) => (
                    <tr key={i}>
                        <td data-toggle='tooltip' data-placement='top' title={row.title}>
                            <a href={`/book/${row.isbn13}`}> {this.truncate(row.title, 40)} </a>
                        </td>
                        <td data-toggle='tooltip' data-placement='top' title={row.categories.join(', ')}>
                            {this.truncate(row.categories.join(', '), 25)}
                        </td>
                        <td style={this.state.style.whiteSpaceNoWrap}>
                            {this.renderAverageRatingStar(parseFloat(row.rating))}
                        </td>
                        <td>
                            <button type="button" className="btn btn-danger btn-sm" onClick={() => this.removeBookFromShelf(row.isbn13, 'readingNow')}>
                                Remove
                            </button>
                        </td>
                    </tr>
                ));
            }
        }

        class ToReadBooksTable extends BaseTableComponent {
            constructor(props) {
                super(props);
            }

            getTableRows() {
                let rows = [];
                {% for record in records %}
                    rows.push({
                        title: '{{ record.title }}',
                        isbn13: '{{ record.isbn13 }}',
                        categories: JSON.parse('{{ record.categories|escapejs }}'.replace(/'/g, '"')),
                        rating: '{{ record.averageRating }}'
                    });
                {% endfor %}

                return rows.map((row, i) => (
                    <tr key={i}>
                        <td data-toggle='tooltip' data-placement='top' title={row.title}>
                            <a href={`/book/${row.isbn13}`}> {this.truncate(row.title, 40)} </a>
                        </td>
                        <td data-toggle='tooltip' data-placement='top' title={row.categories.join(', ')}>
                            {this.truncate(row.categories.join(', '), 25)}
                        </td>
                        <td style={this.state.style.whiteSpaceNoWrap}>
                            {this.renderAverageRatingStar(parseFloat(row.rating))}
                        </td>
                        <td>
                            <button type="button" className="btn btn-danger btn-sm" onClick={() => this.removeBookFromShelf(row.isbn13, 'toRead')}>
                                Remove
                            </button>
                        </td>
                    </tr>
                ));
            }
        }

        class HaveReadBooksTable extends BaseTableComponent {
            constructor(props) {
                super(props);
            }

            getTableRows() {
                let rows = [];
                {% for record in records %}
                    rows.push({
                        title: '{{ record.title }}',
                        isbn13: '{{ record.isbn13 }}',
                        categories: JSON.parse('{{ record.categories|escapejs }}'.replace(/'/g, '"')),
                        rating: '{{ record.averageRating }}'
                    });
                {% endfor %}

                return rows.map((row, i) => (
                    <tr key={i}>
                        <td data-toggle='tooltip' data-placement='top' title={row.title}>
                            <a href={`/book/${row.isbn13}`}> {this.truncate(row.title, 40)} </a>
                        </td>
                        <td data-toggle='tooltip' data-placement='top' title={row.categories.join(', ')}>
                            {this.truncate(row.categories.join(', '), 25)}
                        </td>
                        <td style={this.state.style.whiteSpaceNoWrap}>
                            {this.renderAverageRatingStar(parseFloat(row.rating))}
                        </td>
                        <td>
                            <button type="button" className="btn btn-danger btn-sm" onClick={() => this.removeBookFromShelf(row.isbn13, 'haveRead')}>
                                Remove
                            </button>
                        </td>
                    </tr>
                ));
            }
        }

        class RecommendedBooksTable extends BaseTableComponent {
            constructor(props) {
                super(props);
            }

            getTableRows() {
                let rows = [];
                {% for record in records %}
                    rows.push({
                        title: '{{ record.title }}',
                        isbn13: '{{ record.isbn13 }}',
                        categories: JSON.parse('{{ record.categories|escapejs }}'.replace(/'/g, '"')),
                        rating: '{{ record.averageRating }}'
                    });
                {% endfor %}

                return rows.map((row, i) => (
                    <tr key={i}>
                        <td data-toggle='tooltip' data-placement='top' title={row.title}>
                            <a href={`/book/${row.isbn13}`}> {this.truncate(row.title, 40)} </a>
                        </td>
                        <td data-toggle='tooltip' data-placement='top' title={row.categories.join(', ')}>
                            {this.truncate(row.categories.join(', '), 25)}
                        </td>
                        <td style={this.state.style.whiteSpaceNoWrap}>
                            {this.renderAverageRatingStar(parseFloat(row.rating))}
                        </td>
                    </tr>
                ));
            }
        }

        class FavouriteGenreBooksTable extends BaseTableComponent {
            constructor(props) {
                super(props);
            }

            getTableRows() {
                let rows = [];
                {% for record in records %}
                    rows.push({
                        title: '{{ record.title }}',
                        isbn13: '{{ record.isbn13 }}',
                        categories: JSON.parse('{{ record.categories|escapejs }}'.replace(/'/g, '"')),
                        rating: '{{ record.averageRating }}'
                    });
                {% endfor %}

                return rows.map((row, i) => (
                    <tr key={i}>
                        <td data-toggle='tooltip' data-placement='top' title={row.title}>
                            <a href={`/book/${row.isbn13}`}> {this.truncate(row.title, 40)} </a>
                        </td>
                        <td data-toggle='tooltip' data-placement='top' title={row.categories.join(', ')}>
                            {this.truncate(row.categories.join(', '), 25)}
                        </td>
                        <td style={this.state.style.whiteSpaceNoWrap}>
                            {this.renderAverageRatingStar(parseFloat(row.rating))}
                        </td>
                    </tr>
                ));
            }
        }

        class BaseComponent extends React.Component {
            constructor(props) {
                super(props);

                const params = new URLSearchParams(window.location.search);
                const query = params.get('query') || '';

                this.state = {
                    query: query,
                    tabs: [
                        new Tabs('Rated/Reviewed Books', 'Rated and reviewed books', 'ratedAndReviewed', ['Book', 'Categories', 'Your rating', 'Your comment'],
                            <RatedAndReviewedBooksTable/>),
                        new Tabs('Recently Viewed', 'Recently viewed books', 'recentlyViewed', ['Book', 'Categories', 'Average rating'],
                            <RecentlyViewedBooksTable/>),
                        new Tabs('Favourites', 'Favourite books', 'favouriteRead', ['Book', 'Categories', 'Average rating', 'Action'],
                            <FavouriteReadBooksTable/>),
                        new Tabs('Reading Now', 'Reading now books', 'readingNow', ['Book', 'Categories', 'Average rating', 'Action'],
                            <ReadingNowBooksTable/>),
                        new Tabs('To Read', 'To read books', 'toRead', ['Book', 'Categories', 'Average rating', 'Action'],
                            <ToReadBooksTable/>),
                        new Tabs('Have Read', 'Have read books', 'haveRead', ['Book', 'Categories', 'Average rating', 'Action'],
                            <HaveReadBooksTable/>),
                        new Tabs('Books for Me', 'Recommendation for me', 'recommendedBooks', ['Book', 'Categories', 'Average rating'],
                            <RecommendedBooksTable/>),
                        new Tabs('Favourite Genre Books', 'Favourite genre books', 'favouriteGenreBooks', ['Book', 'Categories', 'Average rating'],
                            <FavouriteGenreBooksTable/>),
                    ]
                }
            }

            render() {
                const params = new URLSearchParams(window.location.search);
                const tab = this.state.tabs.find(item => item.url === params.get('tab')) || null;

                return (
                    <div className='container'>
                        <br></br>
                        <div className='row justify-content-md-center'>
                            <div className='btn-group' role='group' aria-label='Shelf'>
                                {this.state.tabs.map((item, i) =>
                                    <span key={i}>
                                        <button type='button'
                                                onClick={(e) => {
                                                    const url = new URL(window.location.href);
                                                    url.searchParams.set('tab', item.url);
                                                    url.searchParams.set('page', 1);
                                                    url.searchParams.delete('query');
                                                    window.location.href = url.toString();
                                                }}
                                                className={item.isActive() ? 'btn btn-primary' : 'btn btn-light'}>
                                            {item.name}
                                        </button>
                                        &nbsp;
                                    </span>)
                                }
                            </div>
                        </div>

                        <br></br>
                        <div className="row">
                            <input className='form-control' type='text' value={this.state.query}
                                   onChange={(e) => this.setState({query: e.target.value})}
                                   onKeyDown={(e) => {
                                       if (e.key === 'Enter') {
                                           const url = new URL(window.location.href);
                                           if (this.state.query) {
                                               url.searchParams.set('query', this.state.query);
                                           } else {
                                               url.searchParams.delete('query');
                                           }
                                           url.searchParams.set('page', 1);
                                           window.location.href = url.toString();
                                       }
                                   }}
                                   placeholder='Search for something in the table...'></input>
                        </div>

                        <br></br>
                        <div className="row">
                            <h5>{tab.description}</h5>
                        </div>
                        <br></br>

                        <div className="row">
                            {tab ? React.cloneElement(tab.component, {tab: tab}) : null}
                        </div>
                    </div>
                );
            }
        }


        ReactDOM.render(<BaseComponent/>, document.getElementById('div-id-user-shelf-container'));

    </script>

    <script src='https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js'
            integrity='sha512-8Q6Y9XnTbOE+JNvjBQwJ2H8S+UV4uA6hiRykhdtIyDYZ2TprdNmWOUaKdGzOhyr4dCyk287OejbPvwl7lrfqrQ=='
            crossorigin='anonymous' referrerpolicy='no-referrer'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js'
            integrity='sha512-MOCpqoRoisCTwJ8vQQiciZv0qcpROCidek3GTFS6KTk2+y7munJIlKCVkFCYY+p3ErYFXCjmFjnfTTRSC1OHWQ=='
            crossorigin='anonymous' referrerpolicy='no-referrer'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.min.js'
            integrity='sha512-kp7YHLxuJDJcOzStgd6vtpxr4ZU9kjn77e6dBsivSz+pUuAuMlE2UTdKB7jjsWT84qbS8kdCWHPETnP/ctrFsA=='
            crossorigin='anonymous' referrerpolicy='no-referrer'></script>

{% endblock %}